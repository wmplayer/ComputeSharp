<?xml version="1.0" encoding="utf-8"?>
<Project>
  <Import Project="..\build\Directory.Build.targets" />

  <!-- Check whether there is a source generator that should be packed with the project -->
  <PropertyGroup Condition="$(IsPackagedProject)">
    <IsSourceGeneratorAvailableForPacking>false</IsSourceGeneratorAvailableForPacking>
    <IsSourceGeneratorAvailableForPacking Condition="Exists('..\$(MSBuildProjectName).SourceGenerators')">true</IsSourceGeneratorAvailableForPacking>
    <SourceGeneratorReferenceTargetFramework Condition="$(IsSourceGeneratorAvailableForPacking)">$(TargetFrameworks.Split(';')[0].Trim())</SourceGeneratorReferenceTargetFramework>
  </PropertyGroup>

  <!-- Pack the source generator, if present -->
  <ItemGroup Condition="'$(IsSourceGeneratorAvailableForPacking)' == 'true'" Label="Package">
    
    <!-- Source generator reference (to trigger building the generator) -->
    <ProjectReference Condition="'$(TargetFramework)' == '$(SourceGeneratorReferenceTargetFramework)'"
                      Include="..\$(MSBuildProjectName).SourceGenerators\$(MSBuildProjectName).SourceGenerators.csproj"
                      ReferenceOutputAssembly="false" />

    <!-- Pack the source generator from its output directory -->
    <None Include="..\$(MSBuildProjectName).SourceGenerators\bin\$(Configuration)\$(SourceGeneratorReferenceTargetFramework)\$(MSBuildProjectName).SourceGenerators.dll"
          PackagePath="analyzers\dotnet\cs"
          Pack="true"
          Visible="false" />
  </ItemGroup>

  <!--
    Enable trimming support on .NET 6 (we need to use StartsWith since it
    could be a Windows TFM too). This can't be in a target unlike the other
    properties set below, because if that is the case the trimmable attribute
    will be set but the analyzers will not run, so warnings will be skipped.
  -->
  <PropertyGroup Condition="$(TargetFramework.StartsWith('net6.0'))">
    <IsTrimmable>true</IsTrimmable>
    <EnableTrimAnalyzer>true</EnableTrimAnalyzer>
    <EnableAotAnalyzer>true</EnableAotAnalyzer>
    <EnableSingleFileAnalyzer>true</EnableSingleFileAnalyzer>
  </PropertyGroup>

  <!-- Emit the [DisableRuntimeMarshalling] attribute for all .NET 6 projects -->
  <Target Name="EmitDisableRuntimeMarshallingAttribute"
          BeforeTargets="PrepareForBuild">
    <ItemGroup Condition="$(TargetFramework.StartsWith('net6.0'))">
      <AssemblyAttribute Include="System.Runtime.CompilerServices.DisableRuntimeMarshallingAttribute"/>
    </ItemGroup>
  </Target>

  <!-- Emit the [SupportedOSVersion] attribute if needed -->
  <Target Name="EmitSupportedOSVersionAttributeForTargetOS"
          BeforeTargets="PrepareForBuild">
    <ItemGroup Condition="'$(SupportedOSVersion)' != ''">
      <AssemblyAttribute Include="System.Runtime.Versioning.SupportedOSPlatformAttribute">
        <_Parameter1>$(SupportedOSVersion)</_Parameter1>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <!-- Emit the [ComVisible(false)] attribute for UWP and WinUI targets -->
  <Target Name="EmitComVisibleAttributeForUwpProjects"
          BeforeTargets="PrepareForBuild">
    <ItemGroup Condition="$(TargetFramework.StartsWith('uap10.0')) OR $(TargetFramework.StartsWith('net6.0-windows'))">
      <AssemblyAttribute Include="System.Runtime.InteropServices.ComVisibleAttribute">
        <_Parameter1>false</_Parameter1>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <!--
    The following target has been ported from TerraFX.Interop.Windows.
    See: https://github.com/terrafx/terrafx.interop.windows.
    This generates the [module: SkipLocalsInit] attribute for all projects.
  -->
  <PropertyGroup>
    <GeneratedSkipLocalsInitFile Condition="'$(GeneratedSkipLocalsInitFile)' == ''">$(IntermediateOutputPath)$(MSBuildProjectName).SkipLocalsInit.g.cs</GeneratedSkipLocalsInitFile>
    <GeneratedSkipLocalsInitFileLines>
      <![CDATA[//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

[module: System.Runtime.CompilerServices.SkipLocalsInitAttribute]]]>
    </GeneratedSkipLocalsInitFileLines>
  </PropertyGroup>

  <Target Name="GenerateSkipLocalsInit"
          BeforeTargets="BeforeCompile;CoreCompile"
          DependsOnTargets="PrepareForBuild"
          Condition="'$(Language)' == 'C#'"
          Inputs="$(MSBuildAllProjects)"
          Outputs="$(GeneratedSkipLocalsInitFile)">

    <!-- Write the file with the attribute -->
    <WriteLinesToFile Lines="$(GeneratedSkipLocalsInitFileLines)" Overwrite="true" WriteOnlyWhenDifferent="true" File="$(GeneratedSkipLocalsInitFile)" />

    <!-- Include the generated file in the list of files to compile -->
    <ItemGroup>
      <Compile Include="$(GeneratedSkipLocalsInitFile)" />
    </ItemGroup>
  </Target>
</Project>